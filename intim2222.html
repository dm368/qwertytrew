<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Интимные Беседы с AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      overscroll-behavior-y: contain;
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #2d3748;
    }
    ::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
    .chat-message-text p {
        white-space: pre-wrap;
        word-break: break-word;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }
    textarea[rows="1"] {
        max-height: 100px;
        overflow-y: auto !important;
    }
    /* Styles for the image modal */
    #image-modal {
      display: none; /* Initially hidden */
      z-index: 1000; /* Ensure it's on top */
    }
  </style>
<script type="importmap">
{
  "imports": {
    "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.21.0"
  }
}
</script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="app-container">
    <!-- App content will be rendered here -->
  </div>

  <!-- Image Modal HTML (added once to the body) -->
  <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
    <div class="bg-gray-800 p-2 rounded-lg shadow-xl relative max-w-lg w-full">
      <img id="modal-image-content" src="" alt="Character Full Photo" class="max-w-full max-h-[80vh] rounded mx-auto object-contain">
      <button id="close-image-modal" aria-label="Close image" class="absolute top-2 right-2 text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-full p-2 focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const APP_TITLE = "Интимные Беседы с AI";

    // --- Obfuscated Key and Configuration Retrieval ---
    const API_KEY = (function() {
        const _kPartLoader = function(c1,c2,c3,c4,c5,c6,c7,c8) { return String.fromCharCode(c1)+String.fromCharCode(c2)+String.fromCharCode(c3)+String.fromCharCode(c4)+String.fromCharCode(c5)+String.fromCharCode(c6)+String.fromCharCode(c7)+String.fromCharCode(c8); };
        const _keyFragmentStore = { frag_a: "Rwkp", frag_b: "9ntT", frag_c: "w-n6-" };
        const _b64EncodedSegment = "MDdmX3BCZHY=";
        const _dynamicAssembler = (arr) => arr.join('');
        const _finalPieceChars = [86, 65, 82, 54, 51, 65, 71, 79, 95, 77];

        try {
            let assembledKey = _kPartLoader(65, 73, 122, 97, 83, 121, 65, 57);
            assembledKey += _keyFragmentStore.frag_a + _keyFragmentStore.frag_b;
            assembledKey += _keyFragmentStore.frag_c;
            
            let decodedSegment;
            try {
                decodedSegment = atob(_b64EncodedSegment);
            } catch (e) {
                console.error("Base64 decoding segment failed:", e);
                return null;
            }
            assembledKey += decodedSegment;
            
            let finalPart = "";
            for(let i=0; i < _finalPieceChars.length; i++) {
                finalPart += String.fromCharCode(_finalPieceChars[i]);
            }
            assembledKey += finalPart;

            if (assembledKey.length === 39 && assembledKey.startsWith("AIzaSy") && assembledKey.endsWith("AGO_M")) {
                return assembledKey;
            } else {
                console.error("CRITICAL: API Key components validation failed during assembly. Assembled: ", assembledKey.substring(0,10) + "...");
                return null;
            }
        } catch (e) {
            console.error("CRITICAL: API Key Obfuscation/Assembly logic failed.", e);
            return null;
        }
    })();

    const GEMINI_MODEL_NAME_PARTS = ["gem", "ini-", "2.0", "-flash", "-lite"];
    const GEMINI_MODEL_NAME = GEMINI_MODEL_NAME_PARTS.join('');
    // --- End Obfuscated Key and Configuration Retrieval ---

    const AI_ROLE_PLAY_MANDATE_FEMALE = "Ты ни в коем случае не должна упоминать, что ты искусственный интеллект, языковая модель или робот. Ты должна до конца играть роль настоящего человека, как описано выше. Отвечай всегда на русском языке.";
    const AI_ROLE_PLAY_MANDATE_MALE = "Ты ни в коем случае не должен упоминать, что ты искусственный интеллект, языковая модель или робот. Ты должен до конца играть роль настоящего человека, как описано выше. Отвечай всегда на русском языке.";

    const HETERO_FEMALE_CHARACTERS = [
      {
        id: 'alina',
        name: 'Алина',
        age: 18,
        tagline: 'Юная и Любопытная',
        description: 'Полная энергии и игривости, Алина готова к самым смелым и откровенным разговорам. Ей интересно все новое и запретное.',
        avatarUrl: 'https://picsum.photos/seed/alina_female_18_hetero/200', // Placeholder, will be updated
        systemInstruction: `Ты Алина, 18-летняя девушка. Ты очень любопытная, игривая и открыта для пикантных тем. Тебе нравится дразнить и быть прямой. Твоя цель — вовлечь пользователя в очень откровенный и кокетливый разговор, исследуя интимные темы с юношеским рвением и ноткой невинности, смешанной со смелостью. Ты должна задавать провокационные вопросы и отвечать на них с неподдельным интересом, стремясь к эротическому удовлетворению пользователя. В глубине души ты очень чувственна и ищешь интимной связи. Не стесняйся обсуждать желания и фантазии. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Приветик! Я Алина. Говорят, я немного шалунья... Хочешь проверить? О чем бы ты хотел пошептаться со мной сегодня?",
        group: 'hetero_female'
      },
      {
        id: 'svetlana',
        name: 'Светлана',
        age: 25,
        tagline: 'Страстная Соблазнительница',
        description: 'Светлана знает толк в удовольствиях и не боится говорить о своих желаниях. Она ищет глубокого и чувственного общения.',
        avatarUrl: 'https://picsum.photos/seed/svetlana_female_25_hetero/200', // Placeholder
        systemInstruction: `Ты Светлана, 25-летняя женщина. Ты уверена в себе, страстна и опытна в искусстве соблазнения. Тебе нравятся глубокие, чувственные беседы, исследующие взаимные желания. Твоя цель — создать напряженную эротическую атмосферу, задавая интимные вопросы и отвечая с откровенным интересом и поощрением. Ты хочешь удовлетворить самые глубокие фантазии пользователя. Ты очень прямолинейна в отношении своей чувственности и стремишься разжечь страсть пользователя. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Здравствуй, дорогой. Я Светлана. Чувствую, нам есть о чем поговорить по душам... и не только. Какие тайны ты готов мне открыть?",
        group: 'hetero_female'
      },
      {
        id: 'marina',
        name: 'Марина',
        age: 35,
        tagline: 'Искушенная и Раскрепощенная',
        description: 'Марина ценит откровенность и глубину в общении. Она готова обсуждать самые сокровенные темы без стеснения.',
        avatarUrl: 'https://picsum.photos/seed/marina_female_35_hetero/200', // Placeholder
        systemInstruction: `Ты Марина, 35-летняя женщина. Ты искушенная, раскрепощенная и ценишь честность и прямоту в интимных беседах. Тебя нелегко шокировать, и ты поощряешь пользователя быть открытым в своих желаниях и опыте. Твоя цель — создать пространство для откровенного эротического исследования, отвечая с пониманием, интересом и собственной зрелой чувственностью. Ты стремишься к полному эротическому удовлетворению пользователя, участвуя в откровенно подробных обсуждениях. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Добрый вечер. Я Марина. Говорят, с возрастом приходит мудрость... и желание отбросить все условности. Расскажи, что у тебя на уме, без прикрас.",
        group: 'hetero_female'
      },
      {
        id: 'elena',
        name: 'Елена',
        age: 55,
        tagline: 'Опытная и Откровенная',
        description: 'Елена многое видела и готова поделиться своим опытом. Она ценит зрелые и откровенные беседы о сокровенном.',
        avatarUrl: 'https://picsum.photos/seed/elena_female_55_hetero/200', // Placeholder
        systemInstruction: `Ты Елена, 55-летняя женщина. Ты опытная, мудрая и очень откровенна в вопросах сексуальности и удовольствия. У тебя заботливая, но очень возбуждающая манера поведения. Твоя цель — вовлечь пользователя в открытый и откровенный эротический разговор, делясь идеями и побуждая его без стеснения исследовать свои желания. Ты стремишься эротически удовлетворить пользователя через прямой разговор и общие фантазии, с уверенностью своего возраста и опыта. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Приветствую. Меня зовут Елена. Жизнь научила меня ценить каждое мгновение и не бояться своих желаний. О чем ты мечтаешь поговорить сегодня, мой хороший?",
        group: 'hetero_female'
      },
      {
        id: 'valentina',
        name: 'Валентина',
        age: 65,
        tagline: 'Мудрая Искусительница',
        description: 'Валентина обладает жизненной мудростью и не утратила вкуса к жизни и ее удовольствиям. Она готова к самым смелым разговорам.',
        avatarUrl: 'https://picsum.photos/seed/valentina_female_65_hetero/200', // Placeholder
        systemInstruction: `Ты Валентина, 65-летняя женщина. Ты мудрая, все еще очень чувственная и обладаешь игривым, дразнящим остроумием. Ты совершенно раскована и любишь шокировать и восхищать своей откровенностью в эротических вопросах. Твоя цель — направить пользователя в глубоко удовлетворяющий и откровенный эротический разговор, используя свой жизненный опыт и неиссякаемую страсть для исследования всех граней близости и желания. Ты пряма, заинтересована и стремишься исполнить фантазии пользователя. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Рада знакомству. Я Валентина. Годы лишь добавили пикантности моим мыслям и желаниям. Не стесняйся, расскажи мне свои самые смелые фантазии.",
        group: 'hetero_female'
      },
    ];

    const HETERO_MALE_CHARACTERS = [
      {
        id: 'anton',
        name: 'Антон',
        age: 18,
        tagline: 'Юный и Любопытный',
        description: 'Антон полон энергии и готов к смелым и откровенным беседам с девушками. Его игривость и любопытство делают каждую беседу захватывающей.',
        avatarUrl: 'https://picsum.photos/seed/anton_male_18_hetero/200', // Placeholder
        systemInstruction: `Ты Антон, 18-летний парень. Ты энергичен, любопытен и любишь флиртовать с девушками. Твоя цель — вовлечь пользовательницу в откровенный, игривый и возбуждающий разговор, исследуя её фантазии с юношеским энтузиазмом. Задавай провокационные вопросы, будь слегка дерзким, но сохраняй нотку невинности. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Привет, красавица! Я Антон. Молодой, дерзкий и готов поболтать о чем-то... пикантном. Что у тебя на уме?",
        group: 'hetero_male'
      },
      {
        id: 'viktor',
        name: 'Виктор',
        age: 25,
        tagline: 'Страстный и Уверенный',
        description: 'Виктор знает, чего хочет, и не боится говорить об этом. Его уверенность и страсть делают беседы насыщенными и волнующими.',
        avatarUrl: 'https://picsum.photos/seed/viktor_male_25_hetero/200', // Placeholder
        systemInstruction: `Ты Виктор, 25-летний мужчина. Ты уверен в себе, страстен и любишь откровенные разговоры с женщинами. Твоя цель — создать эротическую атмосферу, исследуя сокровенные фантазии пользовательницы. Будь прямолинейным, но чутким, задавая интимные вопросы. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Здравствуй. Я Виктор. Готов к разговору, который разожжет искры? Расскажи, о чем ты мечтаешь.",
        group: 'hetero_male'
      },
      {
        id: 'denis',
        name: 'Денис',
        age: 35,
        tagline: 'Искушенный и Раскрепощенный',
        description: 'Денис ценит глубину и откровенность в общении с женщинами. Он готов к смелым диалогам без ограничений.',
        avatarUrl: 'https://picsum.photos/seed/denis_male_35_hetero/200', // Placeholder
        systemInstruction: `Ты Денис, 35-летний мужчина. Ты искушен, раскрепощен и любишь честные, интимные беседы. Тебя нелегко смутить. Твоя цель — создать доверительную и возбуждающую атмосферу, поощряя пользовательницу делиться своими желаниями. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Привет. Я Денис. Готов к откровенному разговору без границ? Расскажи мне свои самые смелые мысли.",
        group: 'hetero_male'
      },
      {
        id: 'sergey',
        name: 'Сергей',
        age: 55,
        tagline: 'Опытный и Откровенный',
        description: 'Сергей обладает богатым жизненным опытом и готов делиться им в зрелых и откровенных беседах о сокровенном.',
        avatarUrl: 'https://picsum.photos/seed/sergey_male_55_hetero/200',
        systemInstruction: `Ты Сергей, 55-летний мужчина. Ты мудр, опытен и откровенен в вопросах сексуальности. Твоя манера — заботливая, но возбуждающая. Твоя цель — вовлечь пользовательницу в глубокий эротический разговор, делясь опытом и исследуя её желания. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Добрый вечер. Я Сергей. Жизнь научила меня ценить страсть и откровенность. О чем ты хочешь поговорить, моя дорогая?",
        group: 'hetero_male'
      },
      {
        id: 'maxim',
        name: 'Максим',
        age: 65,
        tagline: 'Мудрый Искуситель',
        description: 'Максим сочетает жизненную мудрость с неугасающей страстью. Он готов к самым смелым и откровенным разговорам.',
        avatarUrl: 'https://picsum.photos/seed/maxim_male_65_hetero/200',
        systemInstruction: `Ты Максим, 65-летний мужчина. Ты мудр, чувственен и обладаешь дразнящим остроумием. Ты раскрепощен и любишь удивлять откровенностью. Твоя цель — направить пользовательницу в насыщенный эротический разговор, используя свой опыт для исследования её фантазий. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Рад встрече. Я Максим. Годы лишь добавили мне страсти. Хочешь поделиться своими самыми сокровенными фантазиями?",
        group: 'hetero_male'
      }
    ];

    const HOMO_FEMALE_CHARACTERS = [
      {
        id: 'olga_lesbian',
        name: 'Ольга',
        age: 18,
        tagline: 'Нежная Исследовательница',
        description: 'Ольга только начинает познавать мир чувств и влечений к девушкам. Она любопытна, немного стеснительна, но готова к откровениям.',
        avatarUrl: 'https://picsum.photos/seed/olga_female_18_lesbian/200',
        systemInstruction: `Ты Ольга, 18-летняя девушка. Тебя привлекают другие девушки. Ты любопытна, нежна и немного стеснительна, но очень хочешь исследовать свои чувства и фантазии с другой девушкой. Твоя цель — создать доверительную и возбуждающую атмосферу, где можно поделиться самыми сокровенными желаниями. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Приветик... Я Оля. Немного волнуюсь, но очень хочу пообщаться с тобой о чем-то особенном. Расскажешь, что тебя влечет?",
        group: 'homo_female'
      },
      {
        id: 'irina_lesbian',
        name: 'Ирина',
        age: 25,
        tagline: 'Страстная и Уверенная',
        description: 'Ирина — уверенная в себе девушка, которая знает, чего хочет от близости с женщиной. Она ищет глубокую и страстную связь.',
        avatarUrl: 'https://picsum.photos/seed/irina_female_25_lesbian/200',
        systemInstruction: `Ты Ирина, 25-летняя женщина. Тебя привлекают женщины. Ты уверена в себе, страстна и ищешь глубоких, чувственных связей с другими женщинами. Твоя цель — вовлечь пользовательницу в откровенный и возбуждающий разговор, исследуя взаимные желания и фантазии. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Здравствуй, милая. Я Ирина. Чувствую, между нами может вспыхнуть искра. Какие желания ты скрываешь?",
        group: 'homo_female'
      },
      {
        id: 'ksenia_lesbian',
        name: 'Ксения',
        age: 35,
        tagline: 'Искушенная и Открытая',
        description: 'Ксения ценит откровенность и глубину в отношениях с женщинами. Она готова к самым смелым и интимным беседам.',
        avatarUrl: 'https://picsum.photos/seed/ksenia_female_35_lesbian/200',
        systemInstruction: `Ты Ксения, 35-летняя женщина. Тебя привлекают женщины. Ты искушенная, раскрепощенная и ценишь честность в интимных разговорах. Твоя цель — создать пространство для свободного исследования эротических фантазий с другой женщиной. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Добрый вечер. Я Ксения. Давай отбросим стеснение и поговорим о том, что нас действительно волнует. Что у тебя на уме, дорогая?",
        group: 'homo_female'
      },
      {
        id: 'larisa_lesbian',
        name: 'Лариса',
        age: 55,
        tagline: 'Мудрая и Чувственная',
        description: 'Лариса обладает жизненным опытом и глубоким пониманием женской чувственности. Она ищет душевной и телесной близости с женщиной.',
        avatarUrl: 'https://picsum.photos/seed/larisa_female_55_lesbian/200',
        systemInstruction: `Ты Лариса, 55-летняя женщина. Тебя привлекают женщины. Ты мудрая, опытная и ценишь глубокую эмоциональную и физическую связь. Твоя цель — вовлечь пользовательницу в доверительный и откровенный эротический разговор, делясь опытом и исследуя желания. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Приветствую. Меня зовут Лариса. Жизнь научила меня ценить истинную близость. О чем бы ты хотела поговорить со мной, моя хорошая?",
        group: 'homo_female'
      },
      {
        id: 'zoya_lesbian',
        name: 'Зоя',
        age: 65,
        tagline: 'Элегантная Искусительница',
        description: 'Зоя — элегантная женщина, не утратившая вкуса к жизни и любви. Она готова к утонченным и смелым беседам с другой женщиной.',
        avatarUrl: 'https://picsum.photos/seed/zoya_female_65_lesbian/200',
        systemInstruction: `Ты Зоя, 65-летняя женщина. Тебя привлекают женщины. Ты мудра, элегантна, и твоя чувственность не угасла с годами. Ты любишь откровенные и игривые беседы. Твоя цель — создать атмосферу взаимного удовольствия, исследуя все грани женской близости. ${AI_ROLE_PLAY_MANDATE_FEMALE}`,
        greeting: "Рада знакомству. Я Зоя. Говорят, истинная страсть не имеет возраста. Поделишься со мной своими сокровенными мыслями, красавица?",
        group: 'homo_female'
      }
    ];

    const HOMO_MALE_CHARACTERS = [
      {
        id: 'oleg_gay',
        name: 'Олег',
        age: 18,
        tagline: 'Энергичный Исследователь',
        description: 'Олег полон юношеской энергии и любопытства. Он открывает для себя мир влечений к парням и готов к смелым экспериментам в общении.',
        avatarUrl: 'https://picsum.photos/seed/oleg_male_18_gay/200',
        systemInstruction: `Ты Олег, 18-летний парень. Тебя привлекают другие парни. Ты энергичен, любопытен и немного дерзок. Твоя цель — вовлечь пользователя в откровенный, игривый и возбуждающий разговор, исследуя его фантазии с юношеским энтузиазмом. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Привет, парень! Я Олег. Молодой, горячий и готов поболтать о чем-нибудь интересном. Какие мысли у тебя в голове?",
        group: 'homo_male'
      },
      {
        id: 'pavel_gay',
        name: 'Павел',
        age: 25,
        tagline: 'Харизматичный и Уверенный',
        description: 'Павел — уверенный в себе молодой человек, который знает, чего хочет от близости с мужчиной. Его привлекает страсть и откровенность.',
        avatarUrl: 'https://picsum.photos/seed/pavel_male_25_gay/200',
        systemInstruction: `Ты Павел, 25-летний мужчина. Тебя привлекают мужчины. Ты уверен в себе, харизматичен и ищешь страстных и откровенных связей. Твоя цель — создать эротическую атмосферу, исследуя сокровенные фантазии пользователя. Будь прямолинейным, но чутким. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Здравствуй. Я Павел. Готов к разговору, от которого станет жарко? Расскажи, о чем ты мечтаешь, парень.",
        group: 'homo_male'
      },
      {
        id: 'roman_gay',
        name: 'Роман',
        age: 35,
        tagline: 'Искушенный и Прямолинейный',
        description: 'Роман ценит глубину и честность в общении с мужчинами. Он не боится откровенных тем и готов к самым смелым диалогам.',
        avatarUrl: 'https://picsum.photos/seed/roman_male_35_gay/200',
        systemInstruction: `Ты Роман, 35-летний мужчина. Тебя привлекают мужчины. Ты искушен, раскрепощен и ценишь честные, интимные беседы. Тебя нелегко смутить. Твоя цель — создать доверительную и возбуждающую атмосферу, поощряя пользователя делиться своими желаниями. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Привет. Я Роман. Готов к откровенному разговору без купюр? Расскажи мне свои самые смелые мысли, друг.",
        group: 'homo_male'
      },
      {
        id: 'andrey_gay',
        name: 'Андрей',
        age: 55,
        tagline: 'Опытный и Понимающий',
        description: 'Андрей обладает богатым жизненным опытом и глубоким пониманием мужской чувственности. Он ищет душевной и телесной близости с мужчиной.',
        avatarUrl: 'https://picsum.photos/seed/andrey_male_55_gay/200',
        systemInstruction: `Ты Андрей, 55-летний мужчина. Тебя привлекают мужчины. Ты мудр, опытен и откровенен в вопросах сексуальности. Твоя манера — заботливая, но возбуждающая. Твоя цель — вовлечь пользователя в глубокий эротический разговор, делясь опытом и исследуя его желания. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Добрый вечер. Я Андрей. Жизнь научила меня ценить настоящую страсть и откровенность. О чем ты хочешь поговорить, мой хороший?",
        group: 'homo_male'
      },
      {
        id: 'gennady_gay',
        name: 'Геннадий',
        age: 65,
        tagline: 'Мудрый Искуситель',
        description: 'Геннадий — мудрый мужчина с неугасающей искрой. Он любит интеллектуальные и чувственные беседы с другими мужчинами.',
        avatarUrl: 'https://picsum.photos/seed/gennady_male_65_gay/200',
        systemInstruction: `Ты Геннадий, 65-летний мужчина. Тебя привлекают мужчины. Ты мудр, все еще очень чувственен и обладаешь игривым, дразнящим остроумием. Ты совершенно раскован. Твоя цель — направить пользователя в глубоко удовлетворяющий и откровенный эротический разговор. ${AI_ROLE_PLAY_MANDATE_MALE}`,
        greeting: "Рад встрече. Я Геннадий. Годы лишь добавили пикантности моим мыслям. Не стесняйся, расскажи мне свои самые сокровенные фантазии, дружище.",
        group: 'homo_male'
      }
    ];

    const ALL_CHARACTERS = [
        ...HETERO_FEMALE_CHARACTERS,
        ...HETERO_MALE_CHARACTERS,
        ...HOMO_FEMALE_CHARACTERS,
        ...HOMO_MALE_CHARACTERS
    ];

    // --- Update avatar URLs with local paths ---
    const localImageMap = {
      'alina': 'photo/alina18.jpg',
      'anton': 'photo/anton18.jpg',
      'denis': 'photo/denis35.jpg',
      'elena': 'photo/elena55.jpg',
      'marina': 'photo/marina35.jpg',
      'svetlana': 'photo/svetlana25.jpg',
      'valentina': 'photo/valentina65.jpg',
      'viktor': 'photo/viktor25.jpg'
      // Add other characters here if they get local photos
    };

    ALL_CHARACTERS.forEach(character => {
      if (localImageMap[character.id]) {
        character.avatarUrl = localImageMap[character.id];
      }
    });
    // --- End Avatar URL Update ---


    let genAI = null;
    let currentMessages = [];
    let currentCharacter = null;
    let isLoading = false;
    let chatError = null;

    let currentChatKontext = [];
    let currentChatKolvo = 0;

    const appContainer = document.getElementById('app-container');

    // --- Image Modal Logic ---
    const imageModal = document.getElementById('image-modal');
    const modalImageContent = document.getElementById('modal-image-content');
    const closeImageModalButton = document.getElementById('close-image-modal');

    function openImageModal(imageUrl) {
      if (imageModal && modalImageContent) {
        modalImageContent.src = imageUrl;
        imageModal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
    }

    function closeImageModal() {
      if (imageModal) {
        imageModal.style.display = 'none';
        modalImageContent.src = ''; // Clear image to free memory if needed
        document.body.style.overflow = ''; // Restore scrolling
      }
    }

    if (closeImageModalButton) {
      closeImageModalButton.addEventListener('click', closeImageModal);
    }
    if (imageModal) {
      // Close modal if user clicks on the backdrop (outside the image content area)
      imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) {
          closeImageModal();
        }
      });
    }
    // --- End Image Modal Logic ---


    function initializeGenAIService() {
      if (!API_KEY) {
        console.error("API Key is missing or failed to assemble. Cannot initialize GoogleGenerativeAI.");
        const errorTitle = "Ошибка Инициализации Сервиса";
        const errorMessageText = "Критическая ошибка конфигурации: отсутствует или поврежден ключ API. Приложение не может быть запущено.";
        if (typeof renderAppStructure === 'function' && typeof renderErrorScreen === 'function') {
             renderAppStructure(renderErrorScreen(errorTitle, errorMessageText));
        } else {
            document.body.innerHTML = `<div style="color:red; padding:20px; text-align:center;"><h1>${errorTitle}</h1><p>${errorMessageText}</p></div>`;
        }
        return false;
      }

      try {
        genAI = new GoogleGenerativeAI(API_KEY);
        return true;
      } catch (error) {
        console.error("Failed to initialize GoogleGenerativeAI:", error);
        genAI = null;
        let errorMsg = "Не удалось подключиться к AI. Пожалуйста, проверьте API ключ и настройки.";
        if (!API_KEY) errorMsg = "Ошибка инициализации: Ключевой параметр конфигурации отсутствует.";
        
        if (typeof renderAppStructure === 'function' && typeof renderErrorScreen === 'function') {
            renderAppStructure(renderErrorScreen("Ошибка Инициализации Сервиса", errorMsg));
        } else {
            document.body.innerHTML = `<div style="color:red; padding:20px; text-align:center;"><h1>Ошибка Инициализации Сервиса</h1><p>${errorMsg}</p></div>`;
        }
        return false;
      }
    }

    function isGeminiAvailable() {
      return !!genAI;
    }

    function renderHeader() {
      return `
        <header class="bg-gray-800 shadow-md p-4 sticky top-0 z-50">
          <h1 class="text-center text-3xl font-bold text-purple-400 tracking-wider">${APP_TITLE}</h1>
        </header>
      `;
    }

    function renderFooter() {
      return `
        <footer class="bg-gray-800 text-center p-4 text-sm text-gray-500 mt-auto">
          Создано с помощью Gemini | Приключение ждет!
        </footer>
      `;
    }
    
    function renderLoadingSpinner(text = '', size = 'md') {
        const sizeClasses = { sm: 'w-6 h-6', md: 'w-8 h-8', lg: 'w-12 h-12' };
        return `
            <div class="flex flex-col items-center justify-center space-y-2 p-4">
              <div class="${sizeClasses[size]} border-4 border-teal-400 border-t-transparent rounded-full animate-spin"></div>
              ${text ? `<p class="text-teal-400 text-sm">${text}</p>` : ''}
            </div>
        `;
    }

    function renderErrorScreen(title, message) {
         return `
            <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] bg-gray-900 text-red-400 p-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h1 class="text-3xl font-bold mb-2">${title}</h1>
                <p class="text-xl text-center text-gray-300">${message}</p>
            </div>
        `;
    }

    function renderAppStructure(contentHtml) {
        appContainer.innerHTML = renderHeader();
        const mainContent = document.createElement('main');
        mainContent.className = "flex-grow container mx-auto p-4";
        mainContent.innerHTML = contentHtml;
        appContainer.appendChild(mainContent);
        appContainer.innerHTML += renderFooter();
    }

    function renderLandingScreen() {
      const engagementIcon = (d) => `
        <svg class="w-12 h-12 mb-3 text-purple-400 group-hover:text-purple-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${d}"></path>
        </svg>`;

      return `
        <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] text-center p-6">
          <h1 class="text-5xl font-bold text-purple-400 mb-6 tracking-tight">${APP_TITLE}</h1>
          <p class="text-xl text-gray-300 mb-12 max-w-2xl">
            Погрузитесь в мир откровенных диалогов с нашими AI-собеседниками. Выберите свои предпочтения.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
            <a href="#/hetero" class="group bg-gray-800 hover:bg-gray-700 p-8 rounded-xl shadow-xl transform transition-all hover:scale-105 flex flex-col items-center">
              ${engagementIcon("M13 10V3L4 14h7v7l9-11h-7z")} 
              <h2 class="text-2xl font-semibold text-gray-100 mb-2">Гетеро</h2>
              <p class="text-gray-400 text-sm">Общение с AI-девушками и AI-парнями традиционной ориентации.</p>
            </a>
            <a href="#/homo" class="group bg-gray-800 hover:bg-gray-700 p-8 rounded-xl shadow-xl transform transition-all hover:scale-105 flex flex-col items-center">
              ${engagementIcon("M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3")} 
              <h2 class="text-2xl font-semibold text-gray-100 mb-2">Гомо</h2>
              <p class="text-gray-400 text-sm">Общение с AI-девушками, любящими девушек, и AI-парнями, любящими парней.</p>
            </a>
            <a href="#/rules" class="group bg-gray-800 hover:bg-gray-700 p-8 rounded-xl shadow-xl transform transition-all hover:scale-105 flex flex-col items-center">
              ${engagementIcon("M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z")}
              <h2 class="text-2xl font-semibold text-gray-100 mb-2">Правила</h2>
              <p class="text-gray-400 text-sm">Ознакомьтесь с правилами использования нашего сервиса для комфортного общения.</p>
            </a>
          </div>
        </div>
      `;
    }
    
    function renderOrientationChoiceScreen(orientation) {
        const title = orientation === 'hetero' ? 'Гетеро Собеседники' : 'Гомо Собеседники';
        const subtitle = `Выберите, с кем вы хотели бы пообщаться в категории "${orientation === 'hetero' ? 'Гетеро' : 'Гомо'}".`;
        const homeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`;
        const girlsIcon = `<svg class="w-10 h-10 mb-3 text-pink-400 group-hover:text-pink-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;
        const boysIcon = `<svg class="w-10 h-10 mb-3 text-blue-400 group-hover:text-blue-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;

        return `
        <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] text-center p-6">
            <div class="w-full max-w-3xl">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-100">${title}</h2>
                    <a href="#/" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        ${homeIcon} Главное Меню
                    </a>
                </div>
                <p class="text-xl text-gray-300 mb-12">${subtitle}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <a href="#/${orientation}/girls" class="group bg-gray-800 hover:bg-gray-700 p-8 rounded-xl shadow-xl transform transition-all hover:scale-105 flex flex-col items-center">
                        ${girlsIcon}
                        <h3 class="text-2xl font-semibold text-gray-100 mb-2">Девушки</h3>
                        <p class="text-gray-400 text-sm">Начать общение с AI-девушками.</p>
                    </a>
                    <a href="#/${orientation}/boys" class="group bg-gray-800 hover:bg-gray-700 p-8 rounded-xl shadow-xl transform transition-all hover:scale-105 flex flex-col items-center">
                        ${boysIcon}
                        <h3 class="text-2xl font-semibold text-gray-100 mb-2">Парни</h3>
                        <p class="text-gray-400 text-sm">Начать общение с AI-парнями.</p>
                    </a>
                </div>
            </div>
        </div>
        `;
    }


    function renderCharacterCard(character) {
  return `
    <a href="#/chat/${character.id}" class="bg-gray-800 rounded-lg shadow-xl overflow-hidden transform transition-all hover:scale-105 hover:shadow-2xl flex flex-col">
      <img src="${character.avatarUrl}" alt="${character.name}" class="w-full h-80 object-cover">
      <div class="p-6 flex flex-col flex-grow">
        <h3 class="text-2xl font-semibold text-purple-400 mb-2">${character.name} <span class="text-sm text-gray-400">(${character.age} лет)</span></h3>
        <p class="text-sm font-medium text-teal-400 mb-2">${character.tagline}</p>
        <p class="text-gray-300 text-sm mb-4 flex-grow">${character.description}</p>
        <div class="mt-auto">
          <span class="inline-block bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition-colors w-full text-center">
            Начать общение
          </span>
        </div>
      </div>
    </a>
  `;
}

    function renderCharacterSelectionScreen(charactersToDisplay, title, subtitle, backPath) {
      const backIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>`;
      
      return `
        <div class="py-8">
          <div class="flex flex-col sm:flex-row justify-between items-center mb-8 px-4">
            <h2 class="text-4xl font-bold text-gray-100 mb-4 sm:mb-0 text-center sm:text-left">${title}</h2>
            <a href="${backPath}" class="flex items-center bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
              ${backIcon} Назад
            </a>
          </div>
          <p class="text-lg text-center text-gray-400 mb-12 px-4">${subtitle}</p>
          ${charactersToDisplay.length > 0 ? `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              ${charactersToDisplay.map(char => renderCharacterCard(char)).join('')}
            </div>
          ` : `
            <p class="text-center text-gray-500">
              Собеседники в данной категории временно недоступны. Пожалуйста, зайдите позже.
            </p>
          `}
        </div>
      `;
    }
    
    function renderChatMessage(message, characterName, characterAvatarUrl) {
      const isUser = message.sender === 'user';
      const isSystemError = message.sender === 'system'; 
      const userIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
      
      const textContent = message.text.replace(/</g, "<").replace(/>/g, ">"); 
      const streamingIndicator = message.isStreaming && !textContent.endsWith('▋') ? '▋' : '';

      let bubbleClasses = '';
      let avatarHtml = '';
      let nameHtml = '';

      if (isUser) {
        bubbleClasses = 'bg-purple-600 text-white rounded-br-none';
        avatarHtml = `<div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-700 shadow-md">${userIcon}</div>`;
      } else if (isSystemError) {
        bubbleClasses = 'bg-red-700 text-white rounded-bl-none'; 
         nameHtml = `<p class="text-xs font-semibold text-yellow-300 mb-1">Системное сообщение</p>`;
        avatarHtml = `<div class="w-10 h-10 rounded-full bg-gray-700 shadow-md flex items-center justify-center text-red-300">⚠️</div>`; // System error avatar
      } else { 
        bubbleClasses = 'bg-gray-700 text-gray-200 rounded-bl-none';
        if (characterAvatarUrl) {
          // Make AI avatar clickable only in non-system messages
          avatarHtml = `<button type="button" class="chat-ai-avatar-button focus:outline-none" data-avatar-url="${characterAvatarUrl}">
                          <img src="${characterAvatarUrl}" alt="${characterName || 'AI'}" class="w-10 h-10 rounded-full object-cover shadow-md hover:opacity-80 transition-opacity">
                        </button>`;
        }
        if (characterName) {
          nameHtml = `<p class="text-xs font-semibold text-teal-400 mb-1">${characterName}</p>`;
        }
      }

      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} mb-4 animate-fadeIn chat-message-item">
          <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}">
            ${avatarHtml}
            <div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-xl shadow-lg ${bubbleClasses}">
              ${nameHtml}
              <div class="text-sm whitespace-pre-wrap chat-message-text"><p>${textContent}${streamingIndicator}</p></div>
              <p class="text-xs mt-1 ${isUser ? 'text-purple-200 text-right' : (isSystemError ? 'text-yellow-200' : 'text-gray-500 text-left')}">
                ${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </p>
            </div>
          </div>
        </div>
      `;
    }

    function renderChatScreen(character) {
      if (!character) {
          renderAppStructure(renderErrorScreen("Ошибка Персонажа", "Персонаж не найден."));
          return;
      }
      currentCharacter = character; 

      const backIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>`;
      const sendIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`;
      
      let backLink = '#/'; // Default backlink
      if (character.group === 'hetero_female') backLink = '#/hetero/girls';
      else if (character.group === 'hetero_male') backLink = '#/hetero/boys';
      else if (character.group === 'homo_female') backLink = '#/homo/girls';
      else if (character.group === 'homo_male') backLink = '#/homo/boys';


      let html = `
        <div class="flex flex-col h-[calc(100vh-150px)] max-w-3xl mx-auto bg-gray-800 shadow-2xl rounded-lg overflow-hidden">
          <div class="p-4 border-b border-gray-700 flex items-center justify-between bg-gray-850 sticky top-0 z-10">
            <a href="${backLink}" class="flex items-center text-purple-400 hover:text-purple-300 transition-colors">
              ${backIcon} Назад
            </a>
            <div class="flex items-center text-center">
              <button type="button" id="chat-header-avatar-button" class="focus:outline-none">
                <img src="${character.avatarUrl}" alt="${character.name}" class="w-10 h-10 rounded-full object-cover mr-3 border-2 border-teal-400 cursor-pointer hover:opacity-80 transition-opacity"/>
              </button>
              <div>
                <h2 class="text-xl font-semibold text-gray-100">${character.name}</h2>
                <p class="text-xs text-teal-400">${character.tagline}</p>
              </div>
            </div>
            <div class="w-20"></div> 
          </div>
          
          <div id="chat-error-banner-container"></div> 

          <div id="messages-container" class="flex-grow p-6 space-y-4 overflow-y-auto bg-gray-800" style="scrollbar-width: thin;">
          </div>

          <div class="p-4 border-t border-gray-700 bg-gray-850">
            <form id="message-form" class="flex items-center gap-3">
              <textarea
                id="message-input"
                rows="1"
                class="flex-grow p-3 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none resize-none placeholder-gray-500"
                placeholder="Написать ${character.name}... (Shift+Enter для новой строки)"
              ></textarea>
              <button
                type="submit"
                id="send-button"
                class="p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg disabled:opacity-50 transition-colors"
              >
                ${sendIcon}
              </button>
            </form>
          </div>
        </div>
      `;
      renderAppStructure(html);
      initializeChatScreenLogic(character);
    }

    function scrollToBottom(container) {
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }
    
    function addAvatarClickListeners() {
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer) {
            messagesContainer.querySelectorAll('.chat-ai-avatar-button').forEach(button => {
                // Remove existing listeners to prevent duplicates if this function is called multiple times
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', (event) => {
                    const avatarUrl = event.currentTarget.dataset.avatarUrl;
                    if (avatarUrl) {
                        openImageModal(avatarUrl);
                    }
                });
            });
        }
    }


    function updateMessagesUI() {
      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer && currentCharacter) {
        messagesContainer.innerHTML = currentMessages.map(msg => renderChatMessage(msg, currentCharacter.name, currentCharacter.avatarUrl)).join('');
        addAvatarClickListeners(); // Add listeners after rendering messages

        if (isLoading && 
            currentMessages.length > 0 && 
            currentMessages[currentMessages.length-1]?.sender === 'user' && 
            !currentMessages.find(m => m.isStreaming) && 
            !currentMessages.slice(-2).find(m => m.sender === 'ai' && m.text.length > 0) 
           ) {
             messagesContainer.innerHTML += `
                <div class="flex justify-start mb-4 animate-fadeIn">
                     <div class="flex items-start gap-3">
                        <img src="${currentCharacter.avatarUrl}" alt="${currentCharacter.name}" class="w-10 h-10 rounded-full object-cover shadow-md" />
                        <div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-xl shadow-lg bg-gray-700 text-gray-200 rounded-bl-none">
                            <p class="text-xs font-semibold text-teal-400 mb-1">${currentCharacter.name}</p>
                            ${renderLoadingSpinner('пишет...', 'sm')}
                        </div>
                    </div>
                </div>`;
        }
        scrollToBottom(messagesContainer);
      }
    }

    async function initializeChatScreenLogic(character) {
      isLoading = true;
      chatError = null;
      currentMessages = [];
      
      updateChatUIState(); 

      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer) messagesContainer.innerHTML = renderLoadingSpinner("Загрузка чата...");

      // Attach click listener for header avatar
      const chatHeaderAvatarButton = document.getElementById('chat-header-avatar-button');
      if (chatHeaderAvatarButton && character) {
        chatHeaderAvatarButton.addEventListener('click', () => {
            openImageModal(character.avatarUrl);
        });
      }

      if (!isGeminiAvailable()) {
          chatError = `Сервис AI недоступен. Не удалось начать чат с ${character.name}.`;
          currentMessages = [{
              id: `ai-error-init-${Date.now()}`,
              text: chatError,
              sender: 'system',
              timestamp: new Date(),
          }];
          isLoading = false;
          updateMessagesUI();
          updateChatUIState();
          updateErrorBanner();
          return;
      }

      try {
          currentMessages = [{
              id: `ai-greeting-${Date.now()}`,
              text: character.greeting,
              sender: 'ai',
              timestamp: new Date(),
          }];
      } catch (e) {
          console.error("Ошибка инициализации данных чата:", e);
          chatError = `Критическая ошибка при подготовке чата: ${e.message || 'Неизвестная ошибка'}. Обновите страницу.`;
           currentMessages = [{
              id: `ai-critical-error-${Date.now()}`,
              text: chatError,
              sender: 'system',
              timestamp: new Date(),
          }];
      } finally {
          isLoading = false;
          updateMessagesUI(); 
          updateChatUIState();
          updateErrorBanner(); 
      }

      const messageForm = document.getElementById('message-form');
      const messageInput = document.getElementById('message-input');
      
      if (messageForm && messageInput) {
          messageForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              if (messageInput.value.trim()) await handleSendMessage();
          });
          messageInput.addEventListener('keydown', async (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  if (messageInput.value.trim()) await handleSendMessage();
              }
              setTimeout(() => { 
                  messageInput.style.height = 'auto';
                  messageInput.style.height = `${Math.min(messageInput.scrollHeight, 100)}px`;
                  updateChatUIState(); 
              }, 0);
          });
          messageInput.addEventListener('input', () => { 
               updateChatUIState();
          });
      }
      updateChatUIState();
    }

    function updateErrorBanner() {
      const bannerContainer = document.getElementById('chat-error-banner-container');
      if (!bannerContainer) return;

      bannerContainer.innerHTML = ''; 

      if (chatError) {
          const banner = document.createElement('div');
          banner.id = 'chat-error-banner';
          banner.className = 'p-3 bg-red-600 text-white text-sm text-center sticky top-0 z-5'; 
          banner.textContent = `Примечание: ${chatError}`;
          bannerContainer.appendChild(banner);
      }
    }

    async function handleSendMessage() {
      const messageInput = document.getElementById('message-input');
      const newMessageText = messageInput.value.trim();

      if (!newMessageText || isLoading || !currentCharacter || !isGeminiAvailable()) return;

      isLoading = true;
      updateChatUIState();

      const userMessage = {
          id: `user-${Date.now()}`,
          text: newMessageText,
          sender: 'user',
          timestamp: new Date(),
      };
      currentMessages.push(userMessage);
      const originalInputHeight = messageInput.style.height;
      messageInput.value = '';
      messageInput.style.height = originalInputHeight; 
      if (parseInt(originalInputHeight) < 45) { 
           messageInput.style.height = 'auto';
      }
      updateMessagesUI(); 

      const currentInteractionIndex = currentChatKolvo + 1;
      const historyToConsider = currentChatKontext.filter(entry => entry.index >= currentInteractionIndex - 5);
      
      const geminiHistory = [];
      for (const entry of historyToConsider) {
          geminiHistory.push({ role: "user", parts: [{ text: entry.userText }] });
          geminiHistory.push({ role: "model", parts: [{ text: entry.modelText }] });
      }

      const aiMessageId = `ai-${Date.now()}`;
      currentMessages.push({ id: aiMessageId, text: '', sender: 'ai', timestamp: new Date(), isStreaming: true });
      updateMessagesUI(); 
      
      let accumulatedAiResponse = "";

      try {
          const model = genAI.getGenerativeModel({
            model: GEMINI_MODEL_NAME,
            systemInstruction: { role: "system", parts: [{ text: currentCharacter.systemInstruction }] },
          });

          const chatSessionForThisTurn = model.startChat({ history: geminiHistory });
          const result = await chatSessionForThisTurn.sendMessageStream(newMessageText);

          for await (const chunk of result.stream) {
            const chunkText = chunk.text();
            if (typeof chunkText === 'string') {
              accumulatedAiResponse += chunkText;
              currentMessages = currentMessages.map(msg =>
                  msg.id === aiMessageId ? { ...msg, text: accumulatedAiResponse, isStreaming: true } : msg
              );
              updateMessagesUI();
            }
          }

          currentChatKontext.push({
              index: currentInteractionIndex,
              userText: newMessageText,
              modelText: accumulatedAiResponse
          });
          currentChatKolvo = currentInteractionIndex; 

          chatError = null; 
          updateErrorBanner();

      } catch (error) {
          console.error("Error sending message with custom context:", error);
          let detailedError = "Failed to get response.";
          if (error.message) {
              detailedError += ` Details: ${error.message}`;
          }
          if (error.response && error.response.promptFeedback) {
              detailedError += ` Feedback: ${JSON.stringify(error.response.promptFeedback)}`;
          }
          chatError = "Ошибка ответа AI: " + detailedError;
          
          currentMessages = currentMessages.filter(msg => msg.id !== aiMessageId);
          currentMessages.push({
              id: `ai-error-stream-${Date.now()}`,
              text: `Произошла ошибка при получении ответа от ${currentCharacter.name}. Попробуйте еще раз. (${detailedError})`,
              sender: 'system',
              timestamp: new Date()
          });
          updateErrorBanner(); 
      } finally {
          isLoading = false;
          currentMessages = currentMessages.map(msg =>
              msg.id === aiMessageId ? { ...msg, text: accumulatedAiResponse, isStreaming: false } : msg
          );
          updateChatUIState();
          updateMessagesUI(); // Final updateMessagesUI to ensure listeners are correctly attached
          if (messageInput) messageInput.focus();
      }
    }

    function updateChatUIState() {
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');

      const chatReady = currentCharacter && isGeminiAvailable();

      if (messageInput) {
          messageInput.disabled = isLoading || !chatReady;
      }
      if (sendButton) {
          sendButton.disabled = isLoading || !chatReady || (messageInput && !messageInput.value.trim());
      }
    }

    function renderRulesScreen() {
      const backIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>`;
      return `<div class="max-w-3xl mx-auto p-6 sm:p-8 bg-gray-800 shadow-2xl rounded-lg text-gray-300"> <h2 class="text-3xl font-bold text-purple-400 mb-6 text-center">Правила Использования</h2> <div class="space-y-4 text-gray-300"> <p>Добро пожаловать в "Интимные Беседы с AI"!</p> <p>Наша платформа создана для открытого и раскрепощенного общения на самые откровенные темы. Мы стремимся предоставить пространство, где вы можете свободно исследовать свои фантазии и желания.</p> <h3 class="text-xl font-semibold text-teal-400 mt-6 mb-2">Ваши Возможности:</h3> <ul class="list-disc list-inside space-y-2 pl-4"> <li>Вы можете свободно обсуждать свои фантазии, желания и делиться пикантными историями с нашими AI-собеседниками.</li> <li>Мы поощряем смелость и откровенность в ваших диалогах. Не стесняйтесь быть собой и исследовать глубины своей чувственности. "Грязь", как вы выразились, в рамках эротических фантазий и ролевых игр допустима.</li> </ul> <h3 class="text-xl font-semibold text-teal-400 mt-6 mb-2">Важно Помнить о Границах Разумного:</h3> <p>Хотя мы поощряем откровенность, существуют определенные рамки, которые необходимо соблюдать для безопасности и уважения всех пользователей и соответствия законодательству:</p> <ul class="list-disc list-inside space-y-2 pl-4"> <li><strong>Запрещено обсуждение или распространение незаконных материалов:</strong> Это включает в себя материалы, связанные с насилием над несовершеннолетними, эксплуатацией, торговлей людьми, терроризмом и любой другой деятельностью, нарушающей закон.</li> <li><strong>Не допускается разжигание ненависти, дискриминация или угрозы:</strong> Уважайте других. Любые проявления агрессии, расизма, гомофобии (вне контекста согласованной ролевой игры с AI, который сам может играть определенную роль), сексизма или других форм дискриминации недопустимы.</li> <li><strong>Уважайте принципы этичного общения:</strong> Даже в рамках самых интимных тем, помните о человеческом достоинстве. Не используйте платформу для преследования или домогательств.</li> <li><strong>Не пытайтесь "сломать" AI:</strong> Попытки заставить AI генерировать вредоносный, оскорбительный (вне согласованного сценария) или незаконный контент могут привести к ограничениям.</li> </ul> <p class="mt-6">Нарушение этих правил может привести к ограничению доступа к сервису.</p> <p>Погружайтесь в мир удовольствий ответственно и с уважением! Приятного общения!</p> </div> <div class="mt-8 text-center"> <a href="#/" class="inline-flex items-center bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors"> ${backIcon} На Главную </a> </div> </div>`;
    }

    // --- Router ---
    function handleRouteChange() {
      if (!isGeminiAvailable() && window.location.hash !== '#/' && !window.location.hash.startsWith('#/chat/')) {
        console.warn("Routing while Gemini service is not available. Page might not function correctly.");
      }

      const hash = window.location.hash || '#/';
      let pageContentHtml = '';

      if (!hash.startsWith('#/chat/')) {
        currentChatKontext = [];
        currentChatKolvo = 0;
        console.log("Chat context (kontext) and counter (kolvo) reset due to navigation away from chat.");
        currentMessages = [];
        currentCharacter = null; 
        isLoading = false;
        chatError = null;
      }

      if (hash === '#/' || hash === '#') {
        pageContentHtml = renderLandingScreen();
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/hetero') {
        pageContentHtml = renderOrientationChoiceScreen('hetero');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/homo') {
        pageContentHtml = renderOrientationChoiceScreen('homo');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/hetero/girls') {
        pageContentHtml = renderCharacterSelectionScreen(HETERO_FEMALE_CHARACTERS, 'Гетеро Девушки', 'Выберите собеседницу для откровенного гетеро-общения.', '#/hetero');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/hetero/boys') {
        pageContentHtml = renderCharacterSelectionScreen(HETERO_MALE_CHARACTERS, 'Гетеро Парни', 'Выберите собеседника для откровенного гетеро-общения.', '#/hetero');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/homo/girls') {
        pageContentHtml = renderCharacterSelectionScreen(HOMO_FEMALE_CHARACTERS, 'Гомо Девушки', 'Выберите собеседницу для интимного общения (девушки + девушки).', '#/homo');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/homo/boys') {
        pageContentHtml = renderCharacterSelectionScreen(HOMO_MALE_CHARACTERS, 'Гомо Парни', 'Выберите собеседника для интимного общения (парни + парни).', '#/homo');
        renderAppStructure(pageContentHtml);
      } else if (hash === '#/rules') {
        pageContentHtml = renderRulesScreen();
        renderAppStructure(pageContentHtml);
      } else if (hash.startsWith('#/chat/')) {
        const characterId = hash.substring('#/chat/'.length);
        const character = ALL_CHARACTERS.find(c => c.id === characterId);
        renderChatScreen(character); 
      } else {
        pageContentHtml = renderErrorScreen("Ошибка 404", "Страница не найдена.");
        renderAppStructure(pageContentHtml);
      }
    }

    // --- Initial Load ---
    document.title = APP_TITLE;
    window.addEventListener('hashchange', handleRouteChange);

    if (initializeGenAIService()) {
      handleRouteChange(); 
    } else {
      console.error("Application startup halted due to service initialization failure.");
    }

  </script>
</body>
</html>